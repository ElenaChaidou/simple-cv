\documentclass[%
  $if(format.pdf-options.papersize)$
    $format.pdf-options.papersize$paper,
  $endif$
  $format.pdf-options.typesize$,
  oneside
  ]{memoir}

\usepackage{enumitem}
%%% Font declarations
\usepackage{fontspec} % Choose fonts intelligently
$if(format.pdf-options.fonts.regular)$
\setmainfont{$format.pdf-options.fonts.regular$.otf}[%
  $if(format.pdf-options.fonts.italic)$
  ItalicFont = $format.pdf-options.fonts.italic$.otf ,
  $endif$
  $if(format.pdf-options.fonts.bold)$
  BoldFont = $format.pdf-options.fonts.bold$.otf ,
  $else$ % The default is not to have a bold font defined…
  BoldFont = $format.pdf-options.fonts.regular$.otf ,
  $endif$
  $if(format.pdf-options.bold-as-smallcaps)$
  BoldFeatures = {Letters=SmallCaps} ,
  $endif$
  $if(format.pdf-options.fonts.smallcaps)$
  SmallCapsFont = $format.pdf-options.fonts.smallcaps$.otf ,
  $endif$
  Path =./fonts/ ,
  Ligatures=Historic ,
  Ligatures=Rare ,
  Mapping=tex-text ,
  ItalicFeatures={Style=Swash} ,
]
$endif$
$if(format.pdf-options.fonts.monospace)$
\setmonofont{$format.pdf-options.fonts.monospace$.otf}[
  Path =./fonts/
]
$endif$

%%% PDF generation
\usepackage[ breaklinks=true, hidelinks ]{hyperref}
\hypersetup{%
            pdftitle={$format.title$},
            pdfauthor={$for(format.author)$$format.author$$sep$, $endfor$},
            pdfborder={0 0 0},
            breaklinks=true}

%%% Layout of the page
$if(format.pdf-options.left-margin)$
  \setlrmarginsandblock{$format.pdf-options.left-margin$}$if(format.pdf-options.right-margin)${$format.pdf-options.right-margin$}$else${*}$endif${*}
$endif$
$if(format.pdf-options.top-margin)$
  \setulmarginsandblock{$format.pdf-options.top-margin$}$if(format.pdf-options.bottom-margin)${$format.pdf-options.bottom-margin$}$else${*}$endif${*}
$endif$
  \setheadfoot{0pt}{\baselineskip} % footer is a baseline tall.
  \setheaderspaces{*}{0pt}{*}

%%% Define the (default) chapter style and choose the chapter
  \makechapterstyle{line}{%
    \setlength{\beforechapskip}{0pt}
    \setlength{\afterchapskip}{0pt}
    \renewcommand*{\chaptitlefont}{\Large\scshape}
    \renewcommand*{\printchaptertitle}[1]{%
    \chaptitlefont ##1 \smallskip\hrule\vspace{\baselineskip}
    }
  }
\chapterstyle{$format.pdf-options.display-style$}

%%% Section styling. We assume two, margin and overlapping.
\setsecnumdepth{subsubsection} % Keep the section counters running (see below).
% This gets complicated, because we need the numbers to roll over so that the
% subsections have an appropriate beforeskip.
$if(format.pdf-options.margin-heading)$
  % margin-heading is set in the ruby script.
  \newcommand{\marginbox}[1]{% Build the small margin header box.
    $if(format.pdf-options.smallcaps-headings)$
    \parbox[t][0pt]{9em}{\parbox[t][0pt]{7em}{\scshape\normalsize \raggedright{} #1}}
    $else$
    \parbox[t][0pt]{9em}{\parbox[t][0pt]{7em}{\raggedright{} #1}}
    $endif$
  }
  \newcommand{\marginhead}[1]{% Pull the margin header into the margin.
    {\hspace{-9em}{\marginbox{#1}}}
  }
  \setsecindent{0em} % no indent in the margin
  \setaftersecskip{0em} % no space after the heading
  \setsecheadstyle{\marginhead}
  \setlength{\parindent}{0em} % no indent for paragraphs
$else$
  % using regular headings mode
  $if(format.pdf-options.smallcaps-headings)$
    \setsecheadstyle{\large\scshape}
  $else$
    \setsecheadstyle{\large}
  $endif$
    \setaftersecskip{\baselineskip} % add a blank line after the heading
    \setlength{\parindent}{3em} % indent paragraphs
$endif$
% Blank out all printed counters and their teeny spaces. Vital both for
% sections and subsections.
\makeatletter % enter into macro mode
\renewcommand{\@seccntformat}[1]{}
\makeatother % exit macro mode.

%%% Subsection styling. Should someone (me) include subsections in their CV,
% things get complex.

\setsubsecheadstyle{\normalsize} % Subheads shouldn’t be big.
\setaftersubsecskip{0em} % Subheads should have no space after them
% New problem: \subsection should have no top margin, so it’s in line w/ the 
% section header. But if that’s the case, when a subsection appears later in
% the section, it looks just like a regular line. We need subsection to have
% conditional beforeskips, based on whether it’s the first subsection or not.
\let\oldsubsection\subsection % to avoid recursion
\renewcommand{\subsection}[1]{%
  \ifnumequal{\value{subsection}}{0} % If this is the first subsection
  {\setbeforesubsecskip{0em} \oldsubsection{#1}} % make beforeskip 0
  {\setbeforesubsecskip{\medskipamount} \oldsubsection{#1}} % else add a skip
}
$if(format.pdf-options.margin-heading)$
  \setsubsecindent{0em} % In margin, subsection headings shouldn’t be indented
$else$
  \setsubsecindent{3em} % In overlapped, yes.
$endif$


%%% List styling. They behave differently based on margin or regular headings.
\setlist[itemize]{nosep} % No gaps between list items.
$if(format.pdf-options.margin-heading)$
  \setlist[itemize,1]{leftmargin=!,labelwidth=1em,labelindent=0em} % Pull list all the way to the left.
$else$
  \setlist[itemize,1]{leftmargin=!,labelwidth=1em,labelindent=3em} % Push list in.
$endif$
% And now the markers.
$if(format.markers)$
\renewcommand{\labelitemi}{$format.markers.level-1$}
\renewcommand{\labelitemii}{$format.markers.level-2$}
\renewcommand{\labelitemiii}{$format.markers.level-3$}
$endif$

\checkandfixthelayout

%%% Format footer
\copypagestyle{chapter}{plain}
$if(format.pdf-options.footer)$
  \makeoddhead{chapter}{}{}{}
  \makeoddfoot{chapter}{}{}{%
    $if(format.pdf-options.footer.display-author)$$for(format.author)$$format.author$$sep$, $endfor$,$endif$  $if(format.pdf-options.footer.last-modified)$\today,$endif$ \thepage}
$else$
  \makeoddhead{chapter}{}{}{}
  \makeoddfoot{chapter}{}{}{\thepage}
$endif$
\pagestyle{chapter}

%%% Redefine \section to tighten vertical space
\let\oldsection\section
\renewcommand{\section}[1]{%
  \oldsection{#1}
  \leavevmode
  \par
  \vspace{\dimexpr-\baselineskip-\parskip}
}


\begin{document}

  $if(personal.display-name)$
    \chapter*{$personal.display-name$}
  $else$
    \chapter*{$personal.name$}
  $endif$

$if(format.pdf-options.margin-heading)$
  \begin{adjustwidth*}{9em}{0em}
  \mbox{}
$endif$

  \hypertarget{contact-information}{%
  \section{$format.contact-information$}\label{contact-information}}
    \begin{minipage}[t]{0.3\textwidth}
      $for(personal.address)$$personal.address$$sep$\\ $endfor$
    \end{minipage}
    \begin{minipage}[t]{0.7\textwidth}
        $if(personal.telephone)$
        {\textit{Tel:}} $personal.telephone$ \\
        $endif$
        $if(personal.email)$
        {\textit{E-mail:}} $personal.email$ \\
        $endif$
        $if(personal.url)$
        {\textit{Web:}} http://$personal.url$ \\
        $endif$
        $if(personal.twitter)$
        {\textit{Twitter:}} \href{http://twitter.com/$personal.twitter$}{@$personal.twitter$} \\
        $endif$
        $if(personal.github)$
        {\textit{GitHub:}} \href{http://github.com/$personal.github$}{@$personal.github$}
        $endif$
    \end{minipage}
  $if(personal.citizenships)$
    % \vspace{\baselineskip}
    \medskip%amount
    \par Citizenship:
    $for(personal.citizenships)$$personal.citizenships$$sep$ and $endfor$
  $endif$
$body$

$if(format.pdf-options.margin-heading)$
  \end{adjustwidth*}
$endif$
\end{document}

